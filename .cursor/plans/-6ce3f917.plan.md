<!-- 6ce3f917-a3f2-4c7c-9e60-d56725f21c9f cae6364c-224e-4345-abcd-d6d35ebff15b -->
# Extend 自动发送通知功能计划

## 目标

当管理员在 `/user` 页面使用 Extend 功能延长用户或全部用户的过期时间时，后端在同一次请求中自动为每个受影响用户写入一条 `notifications` 记录，无需前端再额外调用通知接口。

## 步骤 1：在 Extend API 中同时写入通知

- **文件**：`app/api/users/extend-expiry/route.ts`
- 在当前循环更新每个用户 `expires_at` 的逻辑中，增加构建通知 payload 的代码：
- 结构：`{ user_id, title, message, type, read }`，与现有 `notifications` 表结构保持一致。
- `title` 固定为例如：`"Expiry Extended"`。
- `type` 固定为 `"info"`。
- `message` 模板示例：
  - 单个用户或全部用户统一格式：`Your expiry has been extended by {days} day(s). New expiry: {newExpires.toISOString()}`，也可以改为中文提示。
- 在完成所有用户的新 `expires_at` 计算后，统一将所有待发送通知组成数组，通过 Supabase REST API 一次性 `POST` 到 `/rest/v1/notifications`：
- 头部：`Content-Type`, `apikey`, `Authorization`, `Prefer: return=minimal`。
- Body：通知数组（支持 bulk insert）。
- 错误处理：
- 若通知插入失败但 `expires_at` 已成功更新，记录 error 日志，并返回 200 但在 message 中提示通知部分失败，例如：`"Expiry extended, but failed to create notifications"`。
- 若更新 `expires_at` 本身失败，则保持现有行为：返回 500 并中止。

## 步骤 2：调整返回信息（可选）

- **文件**：`app/api/users/extend-expiry/route.ts`
- 在成功返回的 JSON 中增加一个字段（可选）：
- `notificationsCreated: number`，表示成功插入的通知条数，便于前端调试或将来扩展使用。

## 步骤 3：前端保持不变

- **文件**：`app/user/page.tsx`
- Extend 功能的前端逻辑无需变更：
- 仍通过 `/api/users/extend-expiry` 完成 extend；
- 仍然依赖返回的 `message` 与 `updated` 字段进行 toast 提示；
- 只需在实现后手动验证：
- 单用户 Extend：目标用户在 `notifications` 表中新增通知；
- 全部 Extend：所有用户各新增一条通知。

## 步骤 4：测试要点

- Extend 单个用户（过期和未过期两种情况）并检查：
- `users.expires_at` 是否按预期更新；
- `notifications` 是否为该用户写入一条记录，内容及类型正确。
- Extend 全部用户，确认：
- 所有用户 `expires_at` 均被更新；
- `notifications` 中对应用户数的通知记录被创建。